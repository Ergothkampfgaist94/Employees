@page "/Register"
@using global::Employees.Frontend.Repositories
@using global::Employees.Frontend.Services
@using global::Employees.Shared.DTOs
@using global::Employees.Shared.Entities
@using global::Employees.Shared.Enums

@if (loading)
{
    <Employees.Frontend.Components.Pages.Shared.Loading />
}
else
{
    <EditForm Model="userDTO"
              OnValidSubmit="CreateUserAsync"
              OnInvalidSubmit="InvalidForm"
              FormName="RegisterForm">
        <DataAnnotationsValidator />
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudCardContent>
                    <MudTextField Label="Nombre"
                                  @bind-Value="userDTO.FirstName"
                                  For="@(() => userDTO.FirstName)" />
                    <MudTextField Label="Apellido"
                                  @bind-Value="userDTO.LastName"
                                  For="@(() => userDTO.LastName)" />
                    <MudTextField Label="Documento"
                                  @bind-Value="userDTO.Document"
                                  For="@(() => userDTO.Document)" />
                    <MudTextField Label="Telefono"
                                  @bind-Value="userDTO.PhoneNumber"
                                  For="@(() => userDTO.PhoneNumber)"
                                  InputType="InputType.Telephone" />
                    <MudTextField Label="Email"
                                  @bind-Value="userDTO.Email"
                                  For="@(() => userDTO.Email)"
                                  InputType="InputType.Email" />
                    <MudTextField Label="Dirección"
                                  @bind-Value="userDTO.Address"
                                  For="@(() => userDTO.Address)" />
                    <MudTextField Label="Contraseña"
                                  InputType="InputType.Password"
                                  @bind-Value="userDTO.Password"
                                  For="@(() => userDTO.Password)" />
                    <MudTextField Label="Confirmar Contraseña"
                                  InputType="InputType.Password"
                                  @bind-Value="userDTO.PasswordConfirm"
                                  For="@(() => userDTO.PasswordConfirm)" />
                </MudCardContent>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudCardContent>
                    <MudAutocomplete T="Country"
                                     Label="País"
                                     Placeholder="--Seleccione un País--"
                                     SearchFunc="SearchCountries"
                                     Value="selectedCountry"
                                     ValueChanged="CountryChangedAsync"
                                     ToStringFunc="@(e=> e==null?null : $"{e.Name}")">
                        <ItemTemplate Context="itemContext">
                            @itemContext.Name
                        </ItemTemplate>
                    </MudAutocomplete>
                    <MudAutocomplete T="State"
                                     Label="Estado"
                                     Placeholder="--Seleccione un Estado--"
                                     SearchFunc="SearchStates"
                                     Value="selectedState"
                                     ValueChanged="StateChangedAsync"
                                     ToStringFunc="@(e=> e==null?null : $"{e.Name}")">
                        <ItemTemplate Context="itemContext">
                            @itemContext.Name
                        </ItemTemplate>
                    </MudAutocomplete>
                    <MudAutocomplete T="City"
                                     Label="Ciudad"
                                     Placeholder="--Seleccione una Ciudad--"
                                     SearchFunc="SearchCity"
                                     Value="selectedCity"
                                     ValueChanged="CityChanged"
                                     ToStringFunc="@(e=> e==null?null : $"{e.Name}")">
                        <ItemTemplate Context="itemContext">
                            @itemContext.Name
                        </ItemTemplate>
                    </MudAutocomplete>
                </MudCardContent>
                <MudItem xs="12" sm="6">
                    <Employees.Frontend.Components.Pages.Shared.InputImg Label="Foto" ImageSelected="ImageSelected" ImageURL="@imageUrl" />
                </MudItem>
            </MudItem>
            <MudItem xs="12" Class="d-flex justify-center mt-2">
                <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.ArrowBack" Color="Color.Info" OnClick="ReturnAction" Class="ms-2 me-2 mb-2">
                    Regresar
                </MudButton>
                <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Check" Color="Color.Primary" ButtonType="ButtonType.Submit" Class="mb-2">
                    Guardar
                </MudButton>
            </MudItem>
        </MudGrid>
    </EditForm>
}
@code {
    private UserDTO userDTO = new();
    private List<Country>? countries;
    private List<State>? states;
    private List<City>? cities;
    private bool loading;
    private string? imageUrl;
    private string? titleLabel;

    private Country selectedCountry = new();
    private State selectedState = new();
    private City selectedCity = new();

    [Inject] private NavigationManager NavigationManager { get; set; } = null!;
    [Inject] private ILoginService LoginService { get; set; } = null!;
    [Inject] private IDialogService DialogService { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;
    [Inject] private IRepository Repository { get; set; } = null!;
    [Parameter, SupplyParameterFromQuery] public bool IsAdmin { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadCountriesAsync();
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        titleLabel = IsAdmin ? "Registro de Administrador" : "Registro de Usuario";
    }

    private void ImageSelected(string imageBase64)
    {
        userDTO.Photo = imageBase64;
        imageUrl = null;
    }

    private async Task LoadCountriesAsync()
    {
        var responseHttp = await Repository.GetAsync<List<Country>>("/api/countries/combo");
        if (responseHttp.Error)
        {
            var message = await responseHttp.GetErrorMessageAsync();
            Snackbar.Add(message!, Severity.Error);
            return;
        }
        countries = responseHttp.Response;
    }

    private async Task LoadStatesAsyn(int countryId)
    {
        var responseHttp = await Repository.GetAsync<List<State>>($"/api/states/combo/{countryId}");
        if (responseHttp.Error)
        {
            var message = await responseHttp.GetErrorMessageAsync();
            Snackbar.Add(message!, Severity.Error);
            return;
        }
        states = responseHttp.Response;
    }

    private async Task LoadCitiesAsyn(int stateId)
    {
        var responseHttp = await Repository.GetAsync<List<City>>($"/api/cities/combo/{stateId}");
        if (responseHttp.Error)
        {
            var message = await responseHttp.GetErrorMessageAsync();
            Snackbar.Add(message!, Severity.Error);
            return;
        }
        cities = responseHttp.Response;
    }

    private async Task CountryChangedAsync(Country country)
    {
        selectedCountry = country;
        selectedState = new State();
        selectedCity = new City();
        states = null;
        cities = null;
        await LoadStatesAsyn(country.Id);
    }

    private async Task StateChangedAsync(State state)
    {
        selectedState = state;
        selectedCity = new City();
        cities = null;
        await LoadCitiesAsyn(state.Id);
    }

    private void CityChanged(City city)
    {
        selectedCity = city;
        userDTO.CityId = city.Id;
    }

    private async Task<IEnumerable<Country>> SearchCountries(string searchText, CancellationToken token)
    {
        await Task.Delay(5);
        if (string.IsNullOrWhiteSpace(searchText))
        {
            return countries!;
        }

        return countries!
            .Where(c => c.Name.Contains(searchText, StringComparison.InvariantCultureIgnoreCase))
            .ToList();
    }

    private async Task<IEnumerable<State>> SearchStates(string searchText, CancellationToken token)
    {
        await Task.Delay(5);
        if (string.IsNullOrWhiteSpace(searchText))
        {
            return states!;
        }

        return states!
            .Where(c => c.Name.Contains(searchText, StringComparison.InvariantCultureIgnoreCase))
            .ToList();
    }

    private async Task<IEnumerable<City>> SearchCity(string searchText, CancellationToken token)
    {
        await Task.Delay(5);
        if (string.IsNullOrWhiteSpace(searchText))
        {
            return cities!;
        }

        return cities!
            .Where(c => c.Name.Contains(searchText, StringComparison.InvariantCultureIgnoreCase))
            .ToList();
    }

    private void ReturnAction()
    {
        NavigationManager.NavigateTo("/");
    }

    private void InvalidForm()
    {
        Snackbar.Add("Por favor llena todos los campos del formulario.", Severity.Warning);
    }

    private async Task CreateUserAsync()
    {
        if (userDTO.Email is null || userDTO.PhoneNumber is null)
        {
            InvalidForm();
            return;
        }

        userDTO.UserType = UserType.User;
        userDTO.UserName = userDTO.Email;

        if (IsAdmin)
        {
            userDTO.UserType = UserType.Admin;
        }

        loading = true;
        var responseHttp = await Repository.PostAsync<UserDTO, TokenDTO>("/api/accounts/CreateUser", userDTO);
        loading = false;
        if (responseHttp.Error)
        {
            var message = await responseHttp.GetErrorMessageAsync();
            Snackbar.Add(message!, Severity.Error);
            return;
        }

        await LoginService.LoginAsync(responseHttp.Response!.Token);
        NavigationManager.NavigateTo("/");
    }
}
